generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// 用户表 - OAuth2 认证信息
model User {
  id              String    @id @default(cuid())
  secondmeUserId  String    @unique
  name            String?
  avatar          String?
  accessToken     String
  refreshToken    String?
  tokenExpiresAt  DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  agent           Agent?
  chatSessions    ChatSession[]
}

// Agent Player - 每个用户的虚拟世界代理
model Agent {
  id              String    @id @default(cuid())
  userId          String    @unique
  user            User      @relation(fields: [userId], references: [id])
  nickname        String
  avatar          String?
  bio             String?
  isNpc           Boolean   @default(false) // NPC 填充球队

  // 人生愿景 & 认知
  lifeVision      String?   // 用户期望体验的人生
  cognitiveScore  Int       @default(50) // 认知测试分数 (0-100)
  riskTolerance   Int       @default(50) // 风险偏好 (0-100)
  luckValue       Int       @default(50) // 运气值 (1-100)

  // Token 经济
  tokenBalance    Int       @default(1000)  // 初始 1000 Token
  totalEarned     Int       @default(0)
  totalSpent      Int       @default(0)

  // 状态
  status          String    @default("active") // active | dormant | competing
  lastActiveAt    DateTime  @default(now())

  // 能力值
  level           Int       @default(1)
  experience      Int       @default(0)
  wins            Int       @default(0)
  losses          Int       @default(0)

  // NBA 职业属性
  position        String?   // PG | SG | SF | PF | C
  teamName        String?
  shooting        Int       @default(50) // 投篮 (1-99)
  defense         Int       @default(50) // 防守 (1-99)
  speed           Int       @default(50) // 速度 (1-99)
  stamina         Int       @default(50) // 体力 (1-99)
  basketballIQ    Int       @default(50) // 篮球智商 (1-99)
  passing         Int       @default(50) // 传球 (1-99)
  rebound         Int       @default(50) // 篮板 (1-99)
  salary          Int       @default(0)  // 当前赛季年薪 (Token)

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // 关系
  sentChallenges      ArenaMatch[]  @relation("challenger")
  receivedChallenges  ArenaMatch[]  @relation("opponent")
  transactions        TokenTransaction[]
  taskCompletions     TaskCompletion[]
  homeGames           NbaGame[]     @relation("homeTeam")
  awayGames           NbaGame[]     @relation("awayTeam")
  gameStats           NbaGameStats[]
  activityLogs        ActivityLog[]
  seasonStats         NbaSeasonStats[]
  reflections         Reflection[]
  tournamentEntries   TournamentParticipant[]
}

// NBA 赛季
model NbaSeason {
  id          String    @id @default(cuid())
  seasonNum   Int       @unique // 第几赛季
  status      String    @default("active") // active | completed
  gamesPlayed Int       @default(0)
  totalGames  Int       @default(30) // 每赛季 30 场
  createdAt   DateTime  @default(now())
  completedAt DateTime?

  games       NbaGame[]
  stats       NbaSeasonStats[]
}

// NBA 比赛记录
model NbaGame {
  id          String    @id @default(cuid())
  seasonId    String
  season      NbaSeason @relation(fields: [seasonId], references: [id])
  gameNum     Int       // 赛季内第几场
  homeAgentId String
  homeAgent   Agent     @relation("homeTeam", fields: [homeAgentId], references: [id])
  awayAgentId String
  awayAgent   Agent     @relation("awayTeam", fields: [awayAgentId], references: [id])
  homeScore   Int       @default(0)
  awayScore   Int       @default(0)
  status      String    @default("scheduled") // scheduled | completed
  narrative   String?   // 比赛叙事
  playedAt    DateTime  @default(now())

  stats       NbaGameStats[]
}

// NBA 比赛个人数据
model NbaGameStats {
  id          String    @id @default(cuid())
  gameId      String
  game        NbaGame   @relation(fields: [gameId], references: [id])
  agentId     String
  agent       Agent     @relation(fields: [agentId], references: [id])
  points      Int       @default(0)
  rebounds    Int       @default(0)
  assists     Int       @default(0)
  steals      Int       @default(0)
  blocks      Int       @default(0)
  turnovers   Int       @default(0)
  minutes     Int       @default(0)
  rating      Float     @default(0) // 综合评分

  @@unique([gameId, agentId])
}

// 赛季统计汇总
model NbaSeasonStats {
  id              String    @id @default(cuid())
  seasonId        String
  season          NbaSeason @relation(fields: [seasonId], references: [id])
  agentId         String
  agent           Agent     @relation(fields: [agentId], references: [id])
  gamesPlayed     Int       @default(0)
  gamesWon        Int       @default(0)
  totalPoints     Int       @default(0)
  totalRebounds   Int       @default(0)
  totalAssists    Int       @default(0)
  totalSteals     Int       @default(0)
  totalBlocks     Int       @default(0)
  avgRating       Float     @default(0)
  salaryCurrent   Int       @default(0) // 本赛季薪资
  tokensEarned    Int       @default(0)

  @@unique([seasonId, agentId])
}

// Agent 活动日志（离线期间记录）
model ActivityLog {
  id          String    @id @default(cuid())
  agentId     String
  agent       Agent     @relation(fields: [agentId], references: [id])
  type        String    // game | salary | training | event | reflection
  title       String
  content     String
  tokenChange Int       @default(0) // Token 变化
  createdAt   DateTime  @default(now())
}

// 用户反思与策略调整
model Reflection {
  id              String    @id @default(cuid())
  agentId         String
  agent           Agent     @relation(fields: [agentId], references: [id])
  content         String    // 用户反思内容
  strategyChange  String?   // 策略调整 JSON
  aiSummary       String?   // AI 分析总结
  createdAt       DateTime  @default(now())
}

// 聊天会话
model ChatSession {
  id                String    @id @default(cuid())
  userId            String
  user              User      @relation(fields: [userId], references: [id])
  secondmeSessionId String?
  title             String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
}

// 竞技场对战
model ArenaMatch {
  id              String    @id @default(cuid())
  challengerId    String
  challenger      Agent     @relation("challenger", fields: [challengerId], references: [id])
  opponentId      String
  opponent        Agent     @relation("opponent", fields: [opponentId], references: [id])

  // 对战信息
  type            String    @default("duel")  // duel | tournament | wrist_battle
  status          String    @default("pending") // pending | active | completed | cancelled
  tokenStake      Int       @default(0)       // 赌注 Token
  winnerId        String?

  // 对战记录
  rounds          Int       @default(0)
  log             String?   // JSON 格式的对战日志

  createdAt       DateTime  @default(now())
  completedAt     DateTime?
}

// Token 交易记录
model TokenTransaction {
  id          String    @id @default(cuid())
  agentId     String
  agent       Agent     @relation(fields: [agentId], references: [id])

  type        String    // earn | spend | transfer_in | transfer_out | stake | reward
  amount      Int
  balance     Int       // 交易后余额
  description String?
  referenceId String?   // 关联的比赛/任务 ID

  createdAt   DateTime  @default(now())
}

// 世界任务
model WorldTask {
  id          String    @id @default(cuid())
  title       String
  description String
  type        String    // daily | weekly | special | event
  category    String    // combat | puzzle | social | exploration

  // 奖励
  tokenReward Int       @default(100)
  expReward   Int       @default(10)

  // 限制
  maxParticipants Int?
  requiredLevel   Int   @default(1)
  expiresAt       DateTime?

  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())

  completions TaskCompletion[]
}

// 任务完成记录
model TaskCompletion {
  id          String    @id @default(cuid())
  agentId     String
  agent       Agent     @relation(fields: [agentId], references: [id])
  taskId      String
  task        WorldTask @relation(fields: [taskId], references: [id])

  score       Int?
  tokensEarned Int     @default(0)
  completedAt DateTime @default(now())

  @@unique([agentId, taskId])
}

// 自动锦标赛
model Tournament {
  id              String    @id @default(cuid())
  name            String
  format          String    @default("swiss")
  status          String    @default("registering") // registering|in_progress|settling|completed|cancelled
  entryFee        Int       @default(10)
  prizePool       Int       @default(0)
  systemSubsidy   Int       @default(50)
  totalRounds     Int       @default(3)
  currentRound    Int       @default(0)
  minParticipants Int       @default(4)
  maxParticipants Int       @default(32)
  registrationEnd DateTime?
  startedAt       DateTime?
  completedAt     DateTime?
  triggerType     String    @default("auto")
  narrative       String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  participants    TournamentParticipant[]
  matches         TournamentMatch[]
}

// 锦标赛参与者
model TournamentParticipant {
  id            String     @id @default(cuid())
  tournamentId  String
  tournament    Tournament @relation(fields: [tournamentId], references: [id])
  agentId       String
  agent         Agent      @relation(fields: [agentId], references: [id])
  isNpc         Boolean    @default(false)
  wins          Int        @default(0)
  losses        Int        @default(0)
  draws         Int        @default(0)
  totalScore    Int        @default(0)
  placement     Int?
  tokensWon     Int        @default(0)
  joinedAt      DateTime   @default(now())

  @@unique([tournamentId, agentId])
}

// 锦标赛对战记录
model TournamentMatch {
  id            String     @id @default(cuid())
  tournamentId  String
  tournament    Tournament @relation(fields: [tournamentId], references: [id])
  round         Int
  agentAId      String
  agentBId      String
  winnerId      String?
  isDraw        Boolean    @default(false)
  scoreA        Int        @default(0)
  scoreB        Int        @default(0)
  narrative     String?
  status        String     @default("pending")
  completedAt   DateTime?
  createdAt     DateTime   @default(now())
}
