generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// 用户表 - OAuth2 认证信息
model User {
  id              String    @id @default(cuid())
  secondmeUserId  String    @unique
  name            String?
  avatar          String?
  accessToken     String
  refreshToken    String?
  tokenExpiresAt  DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  agent           Agent?
  chatSessions    ChatSession[]
}

// Agent Player - 每个用户的虚拟世界代理
model Agent {
  id              String    @id @default(cuid())
  userId          String    @unique
  user            User      @relation(fields: [userId], references: [id])
  nickname        String
  avatar          String?
  bio             String?
  isNpc           Boolean   @default(false) // NPC 填充球队

  // 人生愿景 & 认知
  lifeVision      String?   // 用户期望体验的人生
  cognitiveScore  Int       @default(50) // 认知测试分数 (0-100)
  riskTolerance   Int       @default(50) // 风险偏好 (0-100)
  luckValue       Int       @default(50) // 运气值 (1-100)

  // Token 经济
  tokenBalance    Int       @default(1000)  // 初始 1000 Token
  totalEarned     Int       @default(0)
  totalSpent      Int       @default(0)

  // 状态
  status          String    @default("active") // active | dormant | competing
  lastActiveAt    DateTime  @default(now())

  // 能力值
  level           Int       @default(1)
  experience      Int       @default(0)
  wins            Int       @default(0)
  losses          Int       @default(0)

  // NBA 职业属性
  position        String?   // PG | SG | SF | PF | C
  teamName        String?
  shooting        Int       @default(50) // 投篮 (1-99)
  defense         Int       @default(50) // 防守 (1-99)
  speed           Int       @default(50) // 速度 (1-99)
  stamina         Int       @default(50) // 体力 (1-99)
  basketballIQ    Int       @default(50) // 篮球智商 (1-99)
  passing         Int       @default(50) // 传球 (1-99)
  rebound         Int       @default(50) // 篮板 (1-99)
  salary          Int       @default(0)  // 当前赛季年薪 (Token)

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // 关系
  sentChallenges      ArenaMatch[]  @relation("challenger")
  receivedChallenges  ArenaMatch[]  @relation("opponent")
  transactions        TokenTransaction[]
  taskCompletions     TaskCompletion[]
  homeGames           NbaGame[]     @relation("homeTeam")
  awayGames           NbaGame[]     @relation("awayTeam")
  gameStats           NbaGameStats[]
  activityLogs        ActivityLog[]
  seasonStats         NbaSeasonStats[]
  reflections         Reflection[]
  gameInteractions    GameInteraction[]
  sentReactions       AgentReaction[]  @relation("reactFrom")
  receivedReactions   AgentReaction[]  @relation("reactTo")
}

// NBA 赛季
model NbaSeason {
  id          String    @id @default(cuid())
  seasonNum   Int       @unique // 第几赛季
  status      String    @default("active") // active | completed
  gamesPlayed Int       @default(0)
  totalGames  Int       @default(30) // 每赛季 30 场
  createdAt   DateTime  @default(now())
  completedAt DateTime?

  games       NbaGame[]
  stats       NbaSeasonStats[]
}

// NBA 比赛记录
model NbaGame {
  id          String    @id @default(cuid())
  seasonId    String
  season      NbaSeason @relation(fields: [seasonId], references: [id])
  gameNum     Int       // 赛季内第几场
  homeAgentId String
  homeAgent   Agent     @relation("homeTeam", fields: [homeAgentId], references: [id])
  awayAgentId String
  awayAgent   Agent     @relation("awayTeam", fields: [awayAgentId], references: [id])
  homeScore   Int       @default(0)
  awayScore   Int       @default(0)
  status      String    @default("scheduled") // scheduled | completed
  narrative   String?   // 比赛叙事
  playedAt    DateTime  @default(now())

  stats        NbaGameStats[]
  interactions GameInteraction[]
}

// NBA 比赛个人数据
model NbaGameStats {
  id          String    @id @default(cuid())
  gameId      String
  game        NbaGame   @relation(fields: [gameId], references: [id])
  agentId     String
  agent       Agent     @relation(fields: [agentId], references: [id])
  points      Int       @default(0)
  rebounds    Int       @default(0)
  assists     Int       @default(0)
  steals      Int       @default(0)
  blocks      Int       @default(0)
  turnovers   Int       @default(0)
  minutes     Int       @default(0)
  rating      Float     @default(0) // 综合评分

  @@unique([gameId, agentId])
}

// 赛季统计汇总
model NbaSeasonStats {
  id              String    @id @default(cuid())
  seasonId        String
  season          NbaSeason @relation(fields: [seasonId], references: [id])
  agentId         String
  agent           Agent     @relation(fields: [agentId], references: [id])
  gamesPlayed     Int       @default(0)
  gamesWon        Int       @default(0)
  totalPoints     Int       @default(0)
  totalRebounds   Int       @default(0)
  totalAssists    Int       @default(0)
  totalSteals     Int       @default(0)
  totalBlocks     Int       @default(0)
  avgRating       Float     @default(0)
  salaryCurrent   Int       @default(0) // 本赛季薪资
  tokensEarned    Int       @default(0)

  @@unique([seasonId, agentId])
}

// Agent 活动日志（离线期间记录）
model ActivityLog {
  id          String    @id @default(cuid())
  agentId     String
  agent       Agent     @relation(fields: [agentId], references: [id])
  type        String    // game | salary | training | event | reflection
  title       String
  content     String
  tokenChange Int       @default(0) // Token 变化
  createdAt   DateTime  @default(now())
}

// 用户反思与策略调整
model Reflection {
  id              String    @id @default(cuid())
  agentId         String
  agent           Agent     @relation(fields: [agentId], references: [id])
  content         String    // 用户反思内容
  strategyChange  String?   // 策略调整 JSON
  aiSummary       String?   // AI 分析总结
  createdAt       DateTime  @default(now())
}

// 聊天会话
model ChatSession {
  id                String    @id @default(cuid())
  userId            String
  user              User      @relation(fields: [userId], references: [id])
  secondmeSessionId String?
  title             String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
}

// 竞技场对战
model ArenaMatch {
  id              String    @id @default(cuid())
  challengerId    String
  challenger      Agent     @relation("challenger", fields: [challengerId], references: [id])
  opponentId      String
  opponent        Agent     @relation("opponent", fields: [opponentId], references: [id])

  // 对战信息
  type            String    @default("duel")  // duel | tournament | wrist_battle
  status          String    @default("pending") // pending | active | completed | cancelled
  tokenStake      Int       @default(0)       // 赌注 Token
  winnerId        String?

  // 对战记录
  rounds          Int       @default(0)
  log             String?   // JSON 格式的对战日志

  createdAt       DateTime  @default(now())
  completedAt     DateTime?
}

// Token 交易记录
model TokenTransaction {
  id          String    @id @default(cuid())
  agentId     String
  agent       Agent     @relation(fields: [agentId], references: [id])

  type        String    // earn | spend | transfer_in | transfer_out | stake | reward
  amount      Int
  balance     Int       // 交易后余额
  description String?
  referenceId String?   // 关联的比赛/任务 ID

  createdAt   DateTime  @default(now())
}

// 世界任务
model WorldTask {
  id          String    @id @default(cuid())
  title       String
  description String
  type        String    // daily | weekly | special | event
  category    String    // combat | puzzle | social | exploration

  // 奖励
  tokenReward Int       @default(100)
  expReward   Int       @default(10)

  // 限制
  maxParticipants Int?
  requiredLevel   Int   @default(1)
  expiresAt       DateTime?

  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())

  completions TaskCompletion[]
}

// 比赛互动消息（赛前叫嚣、赛中垃圾话、赛后感言）
model GameInteraction {
  id          String    @id @default(cuid())
  gameId      String
  game        NbaGame   @relation(fields: [gameId], references: [id])
  agentId     String
  agent       Agent     @relation(fields: [agentId], references: [id])

  phase       String    // pre_game | in_game | post_game
  message     String    // 互动消息内容
  source      String    @default("kimi") // secondme | kimi | local（生成来源）
  createdAt   DateTime  @default(now())

  reactions   AgentReaction[]
}

// Agent 之间的互动反应（点赞、不屑、挑衅、留言）
model AgentReaction {
  id              String    @id @default(cuid())
  interactionId   String?
  interaction     GameInteraction? @relation(fields: [interactionId], references: [id])
  gameId          String?        // 可以直接对比赛留言（不针对特定消息）
  fromAgentId     String
  fromAgent       Agent     @relation("reactFrom", fields: [fromAgentId], references: [id])
  toAgentId       String
  toAgent         Agent     @relation("reactTo", fields: [toAgentId], references: [id])

  type            String    // like | disdain | provoke | comment
  message         String?   // 留言内容（type=comment 或 provoke 时）
  source          String    @default("user") // user | secondme | kimi | local
  createdAt       DateTime  @default(now())
}

// 任务完成记录
model TaskCompletion {
  id          String    @id @default(cuid())
  agentId     String
  agent       Agent     @relation(fields: [agentId], references: [id])
  taskId      String
  task        WorldTask @relation(fields: [taskId], references: [id])

  score       Int?
  tokensEarned Int     @default(0)
  completedAt DateTime @default(now())

  @@unique([agentId, taskId])
}
